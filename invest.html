<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zyppayx | Invest</title>

<style>
body{font-family:Arial;background:#f6f8fb;margin:0}
header{background:#0a1f44;color:#fff;padding:15px;text-align:center}
.container{padding:15px;max-width:1100px;margin:auto}
.card{background:#fff;border-radius:14px;padding:15px;margin-bottom:18px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
.card img{width:100%;border-radius:12px;margin-bottom:10px}
.card button{width:100%;padding:12px;border:none;border-radius:10px;background:#00c896;color:#fff;font-weight:bold;cursor:pointer}
input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin:8px 0}
.active-card{border-left:6px solid #00c896}
.lock{color:#e74c3c;font-weight:bold}
.ready{color:#00c896;font-weight:bold}
</style>
</head>

<body>

<header>Investment Plans</header>

<div class="container">
  <h3>Available Plans</h3>
  <div id="plans"></div>

  <h3>My Active Investments</h3>
  <div id="active"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore,collection,getDocs,query,where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCQ8TCMUAySwLSBN3-0W1GV4XWateS1rqQ",
  authDomain:"zyppayx-69c54.firebaseapp.com",
  projectId:"zyppayx-69c54"
});
const auth=getAuth(app);
const db=getFirestore(app);

let currentUser=null;

onAuthStateChanged(auth,user=>{
  if(!user){location.href="login.html";return;}
  currentUser=user;
  loadPlans();
  loadActive();
});

async function loadPlans(){
  const wrap=document.getElementById("plans");
  wrap.innerHTML="Loading...";
  const snap=await getDocs(collection(db,"investmentPlans"));
  wrap.innerHTML="";

  snap.forEach(d=>{
    const p=d.data();
    if(p.status!=="active")return;

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <img src="${p.image}">
      <h4>${p.title}</h4>
      <p>ROI: ${p.roiPercent}%</p>
      <p>Duration: ${p.duration} days</p>
      <p>Min: ₦${p.minAmount.toLocaleString()} | Max: ₦${p.maxAmount.toLocaleString()}</p>
      <input type="number" placeholder="Enter amount">
      <p class="ret"></p>
      <button>Proceed</button>
    `;

    const input=card.querySelector("input");
    const ret=card.querySelector(".ret");
    const btn=card.querySelector("button");

    input.oninput=()=>{
      const amt=Number(input.value);
      if(!amt||amt<p.minAmount||amt>p.maxAmount){
        ret.textContent="";
        return;
      }
      const total=amt+(amt*p.roiPercent/100);
      ret.innerHTML=`<b>Total Return:</b> ₦${total.toLocaleString()}`;
    };

    btn.onclick=()=>{
      const amt=Number(input.value);
      if(!amt||amt<p.minAmount||amt>p.maxAmount){
        alert("Invalid amount");
        return;
      }
      location.href=`manual-payment.html?planId=${d.id}&amount=${amt}`;
    };

    wrap.appendChild(card);
  });
}

async function loadActive(){
  const box=document.getElementById("active");
  box.innerHTML="Loading...";
  const q=query(
    collection(db,"investments"),
    where("userId","==",currentUser.uid),
    where("status","==","approved")
  );
  const snap=await getDocs(q);
  box.innerHTML="";

  if(snap.empty){
    box.innerHTML="<p>No active investments</p>";
    return;
  }

  snap.forEach(d=>{
    const inv=d.data();
    const card=document.createElement("div");
    card.className="card active-card";

    const timer=document.createElement("p");

    function tick(){
      const diff=inv.endDate-Date.now();
      if(diff<=0){
        timer.innerHTML="<span class='ready'>Matured</span>";
      }else{
        const d=Math.floor(diff/86400000);
        const h=Math.floor((diff%86400000)/3600000);
        const m=Math.floor((diff%3600000)/60000);
        const s=Math.floor((diff%60000)/1000);
        timer.innerHTML=`<span class='lock'>Locked:</span> ${d}d ${h}h ${m}m ${s}s`;
      }
    }
    setInterval(tick,1000); tick();

    card.innerHTML=`
      <h4>${inv.planTitle}</h4>
      <p>Amount: ₦${inv.amount.toLocaleString()}</p>
      <p>Total Return: ₦${inv.totalReturn.toLocaleString()}</p>
    `;
    card.appendChild(timer);
    box.appendChild(card);
  });
}
</script>
</body>
</html>
