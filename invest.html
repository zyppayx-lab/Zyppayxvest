<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zyppayxvest | Invest</title>
<style>
body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#f6f8fb;}
header { background:#0a1f44;color:#fff;padding:20px;text-align:center;font-size:20px;}
.container { max-width:1100px;margin:auto;padding:15px;}
.card { background:#fff;padding:18px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);}
.card h3 { margin:0 0 10px 0; font-size:16px; color:#0a1f44;}
.card p { margin:4px 0; font-size:14px; color:#666;}
.amount-input { width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid #ddd; font-size:14px;}
.quick-amounts { display:flex; gap:10px; margin-top:8px;}
.quick-amounts button { flex:1; padding:10px; border:none; border-radius:8px; background:#00c896; color:#fff; cursor:pointer;}
button.main-btn { margin-top:10px; padding:12px; background:#0a1f44; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; width:100%;}
nav { position:fixed; bottom:0; width:100%; background:#fff; border-top:1px solid #ddd; display:flex; justify-content:space-around; padding:10px 0;}
nav a { text-decoration:none; color:#555; font-size:13px; text-align:center;}
nav a.active { color:#00c896; font-weight:bold;}
.lock { color:#e74c3c; font-weight:bold;}
.ready { color:#00c896; font-weight:bold;}
button.disabled { background:#ccc; cursor:not-allowed;}
button.active { background:#00c896; color:#fff;}
</style>
</head>
<body>

<header>Choose an Investment Plan</header>
<div class="container" id="plansContainer">
  <p>Loading investment plans...</p>
</div>

<nav>
  <a href="dashboard.html">Home</a>
  <a href="invest.html" class="active">Invest</a>
  <a href="refer.html">Refer</a>
  <a href="alert.html">Alerts</a>
  <a href="profile.html">Profile</a>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQ8TCMUAySwLSBN3-0W1GV4XWateS1rqQ",
  authDomain: "zyppayx-69c54.firebaseapp.com",
  projectId: "zyppayx-69c54"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserId = "";
const selectedAmount = localStorage.getItem("investAmount") || "";

onAuthStateChanged(auth, async user => {
  if(!user){ window.location.href="login.html"; return; }
  currentUserId = user.uid;
  loadPlans();
});

async function loadPlans(){
  const plansRef = collection(db, "investmentPlans");
  const snap = await getDocs(plansRef);
  const container = document.getElementById("plansContainer");
  container.innerHTML="";

  if(snap.empty){ container.innerHTML="<p>No investment plans available.</p>"; return; }

  snap.forEach(planDoc=>{
    const plan = planDoc.data();
    if(plan.status!=="active") return;

    const card = document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <h3>${plan.title}</h3>
      <p>Duration: ${plan.duration} days</p>
      <p>Daily Return: ₦${plan.dailyReturn}</p>
      <p>Total Return: ₦${plan.totalReturn}</p>
      <p>Minimum Amount: ₦${plan.minAmount}</p>
      <input class="amount-input" type="number" min="${plan.minAmount}" placeholder="Enter amount" value="${selectedAmount}">
      <div class="quick-amounts">
        <button>₦${plan.minAmount}</button>
        <button>₦${plan.minAmount*2}</button>
        <button>₦${plan.minAmount*5}</button>
      </div>
      <button class="main-btn">Invest</button>
    `;

    const input = card.querySelector(".amount-input");
    card.querySelectorAll(".quick-amounts button").forEach(btn=>{
      btn.onclick=()=>{ input.value = btn.textContent.replace("₦",""); }
    });

    // Redirect to manual-payment.html
    card.querySelector(".main-btn").onclick=()=>{
      const amt = Number(input.value);
      if(!amt || amt < plan.minAmount){ alert(`Enter amount ≥ ₦${plan.minAmount}`); return; }
      localStorage.setItem("investAmount", amt);
      window.location.href = "manual-payment.html";
    };

    container.appendChild(card);
  });

  loadUserInvestments(); // Show pending/active investments
}

async function loadUserInvestments(){
  const investmentsRef = collection(db, "users", currentUserId, "investments");
  const snap = await getDocs(investmentsRef);
  const container = document.getElementById("plansContainer");

  snap.forEach(invDoc=>{
    const inv = invDoc.data();
    if(!inv.duration || !inv.amount) return;

    const maturity = inv.createdAt.toDate().getTime() + (inv.duration*24*60*60*1000);
    const card = document.createElement("div");
    card.className="card";

    const timer = document.createElement("p");
    const btn = document.createElement("button");
    btn.textContent="Withdraw";
    btn.disabled = true;
    btn.className="disabled";

    function update(){
      const now = Date.now();
      const diff = maturity - now;
      if(diff<=0 && inv.status==="active"){
        timer.innerHTML="<span class='ready'>Investment matured</span>";
        btn.disabled=false;
        btn.className="active";
        btn.onclick=()=>alert("Withdraw flow here");
      } else if(inv.status==="pending"){
        timer.innerHTML="<span class='lock'>Pending approval</span>";
      } else {
        const d=Math.floor(diff/86400000);
        const h=Math.floor((diff%86400000)/3600000);
        const m=Math.floor((diff%3600000)/60000);
        const s=Math.floor((diff%60000)/1000);
        timer.innerHTML=`<span class="lock">Locked:</span> ${d}d ${h}h ${m}m ${s}s`;
      }
    }

    setInterval(update,1000);
    update();

    card.innerHTML=`
      <h3>${inv.planId}</h3>
      <p>Amount: ₦${inv.amount}</p>
      <p>Status: ${inv.status}</p>
    `;
    card.appendChild(timer);
    card.appendChild(btn);
    container.appendChild(card);
  });
}
</script>

</body>
</html>
